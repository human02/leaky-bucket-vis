<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaky Bucket Algorithm Visualization</title>
    <style>
        /* Base Styles and Modern Design System */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 50%, #f3e8ff 100%);
            transition: all 0.5s ease;
        }

        .dark body {
            background: linear-gradient(135deg, #111827 0%, #1e3a8a 50%, #312e81 100%);
            color: #f3f4f6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }

        .dark .card {
            background: #1f2937;
            border-color: #374151;
            color: #f3f4f6;
        }

        .dark .card h3 {
            color: #f9fafb;
            /* A light, visible color for the text */
        }

        .dark .card h2 {
            color: #f9fafb;
            /* A light, visible color for the text */
        }

        .grid {
            display: grid;
            gap: 2rem;
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        @media (min-width: 1024px) {
            .lg\\:grid-cols-2 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            transform: translateY(0);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #4f46e5);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4b5563, #374151);
        }

        .input,
        .select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            color: #111827;
            transition: all 0.3s ease;
        }

        .input:focus,
        .select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .dark .input,
        .dark .select {
            background: #374151;
            border-color: #4b5563;
            color: #f3f4f6;
        }

        /* Step Cards - matching fixed.html style */
        .step-card {
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            color: #1f2937;
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border-color: #93c5fd;
        }

        .dark .step-card {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.4);
            color: #f3f4f6;
        }

        .step-card h3 {
            color: #1f2937;
        }

        .dark .step-card h3 {
            color: #f9fafb;
        }

        .step-card p {
            color: #4b5563;
        }

        .dark .step-card p {
            color: #e5e7eb;
        }

        .step-number {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
            color: white;
            margin-right: 0.75rem;
            flex-shrink: 0;
            background: #3b82f6;
        }

        /* Status Messages */
        .status-message {
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            transition: all 0.5s ease;
            transform: translateY(0);
            opacity: 1;
            text-align: center;
            font-weight: 500;
        }

        .status-success {
            background: #ffedd5;
            border-color: #fdba74;
            color: #b45309;
        }

        .status-error {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #991b1b;
        }

        .status-info {
            background: #dbeafe;
            border-color: #93c5fd;
            color: #1e40af;
        }

        .status-processed {
            background: #dcfce7;
            border-color: #86efac;
            color: #166534;
        }

        .dark .status-success {
            background: rgba(251, 146, 60, 0.12);
            border-color: rgba(251, 146, 60, 0.32);
            color: #fdba74;
        }

        .dark .status-error {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }

        .dark .status-info {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
            color: #93c5fd;
        }

        .dark .status-processed {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
            color: #86efac;
        }

        /* Utility Classes */
        .text-center {
            text-align: center;
        }

        .text-4xl {
            font-size: 2.25rem;
            line-height: 2.5rem;
        }

        .text-2xl {
            font-size: 1.5rem;
            line-height: 2rem;
        }

        .text-xl {
            font-size: 1.25rem;
            line-height: 1.75rem;
        }

        .text-lg {
            font-size: 1.125rem;
            line-height: 1.75rem;
        }

        .text-sm {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }

        .text-xs {
            font-size: 0.75rem;
            line-height: 1rem;
        }

        .font-bold {
            font-weight: 700;
        }

        .font-semibold {
            font-weight: 600;
        }

        .font-medium {
            font-weight: 500;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-3 {
            margin-bottom: 0.75rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .mb-8 {
            margin-bottom: 2rem;
        }

        .mt-8 {
            margin-top: 2rem;
        }

        .pt-6 {
            padding-top: 1.5rem;
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .items-start {
            align-items: flex-start;
        }

        .justify-center {
            justify-content: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .space-x-2>*+* {
            margin-left: 0.5rem;
        }

        .space-y-4>*+* {
            margin-top: 1rem;
        }

        .space-y-6>*+* {
            margin-top: 1.5rem;
        }

        .w-full {
            width: 100%;
        }

        .min-h-screen {
            min-height: 100vh;
        }

        .rounded-full {
            border-radius: 9999px;
        }

        .border-t {
            border-top-width: 1px;
        }

        .border-gray-200 {
            border-color: #e5e7eb;
        }

        .dark .border-gray-700 {
            border-color: #374151;
        }

        .text-gray-600 {
            color: #4b5563;
        }

        .text-gray-800 {
            color: #1f2937;
        }

        .dark .text-gray-300 {
            color: #f9fafb;
        }

        .dark .text-gray-200 {
            color: #e5e7eb;
        }

        .max-w-2xl {
            max-width: 42rem;
        }

        .mx-auto {
            margin-left: auto;
            margin-right: auto;
        }

        .hidden {
            display: none;
        }

        .gradient-text {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dark .gradient-text {
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dark-toggle {
            padding: 0.75rem;
            border-radius: 50%;
            background: white;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s ease;
            transform: translateY(0);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 3rem;
            height: 3rem;
        }

        .dark .dark-toggle {
            background: #1f2937;
            border-color: #374151;
        }

        .dark-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .dark-toggle svg {
            width: 1.25rem;
            height: 1.25rem;
            stroke: #4b5563;
            transition: all 0.3s ease;
        }

        .dark .dark-toggle svg {
            stroke: #d1d5db;
        }

        /* Bucket Visualization Styles */
        .bucket-container {
            position: relative;
            height: 24rem;
            width: 100%;
            margin-bottom: 1rem;
        }

        .bucket-visual {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 300px;
            border: 4px solid #6b7280;
            border-top: none;
            border-radius: 0 0 60px 60px;
            background: rgba(156, 163, 175, 0.1);
            overflow: hidden;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .dark .bucket-visual {
            border-color: #9ca3af;
            background: rgba(156, 163, 175, 0.05);
        }

        .bucket-water {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.4), rgba(99, 102, 241, 0.4));
            transition: all 0.5s ease;
            border-radius: 0 0 56px 56px;
        }

        .bucket-queue {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            height: calc(100% - 16px);
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            justify-content: flex-start;
            gap: 4px;
            z-index: 10;
        }

        .request-item {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .incoming-request-container {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            height: 80px;
            width: 32px;
            z-index: 20;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .leaking-request-container {
            position: absolute;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%);
            height: 48px;
            width: 32px;
            z-index: 20;
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .queue-status {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 600;
        }

        .dark .queue-status {
            color: #d1d5db;
        }

        /* Animation Classes */
        @keyframes drop-in {
            0% {
                transform: translateY(-60px);
                opacity: 0;
                border-radius: 50%;
            }

            60% {
                transform: translateY(-5px);
                opacity: 1;
                border-radius: 50%;
            }

            80% {
                transform: translateY(-1px);
                border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
                border-radius: 50%;
            }
        }

        .animate-drop-in {
            animation: drop-in 0.3s ease-out forwards;
        }

        @keyframes drop-reject {
            0% {
                transform: translateY(-60px) translateX(0);
                opacity: 0;
                border-radius: 50%;
            }

            40% {
                transform: translateY(-5px) translateX(0);
                opacity: 1;
                border-radius: 50%;
            }

            60% {
                transform: translateY(2px) translateX(0);
                opacity: 1;
                border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            }

            100% {
                transform: translateY(25px) translateX(-35px) rotate(-20deg);
                opacity: 0;
                border-radius: 50%;
            }
        }

        .animate-drop-reject {
            animation: drop-reject 0.6s ease-in-out forwards;
        }

        @keyframes leak-out {
            0% {
                transform: translateY(0);
                opacity: 1;
                border-radius: 50%;
            }

            30% {
                border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            }

            70% {
                border-radius: 50% 50% 50% 50% / 70% 70% 30% 30%;
                opacity: 0.7;
            }

            100% {
                transform: translateY(40px);
                opacity: 0;
                border-radius: 50%;
            }
        }

        .animate-leak-out {
            animation: leak-out 1.2s ease-in forwards;
        }

        /* Control Section */
        .control-section {
            padding: 1rem;
        }

        .control-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            align-items: end;
        }

        @media (max-width: 640px) {
            .control-grid {
                grid-template-columns: 1fr;
            }
        }

        .control-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 0.375rem;
        }

        .dark .control-label {
            color: #d1d5db;
        }

        /* Advantages and Disadvantages boxes - matching explanation boxes style */
        .advantages-box {
            padding: 1rem;
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            border: 1px solid #86efac;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            color: #1f2937;
        }

        .dark .advantages-box {
            background: rgba(34, 197, 94, 0.15);
            border-color: rgba(34, 197, 94, 0.4);
            color: #f3f4f6;
        }

        .advantages-box h3 {
            color: #1f2937;
        }

        .dark .advantages-box h3 {
            color: #f9fafb;
        }

        .advantages-box p,
        .advantages-box li {
            color: #4b5563;
        }

        .dark .advantages-box p,
        .dark .advantages-box li {
            color: #e5e7eb;
        }

        .disadvantages-box {
            padding: 1rem;
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border: 1px solid #fca5a5;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            color: #1f2937;
        }

        .dark .disadvantages-box {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.4);
            color: #f3f4f6;
        }

        .disadvantages-box h3 {
            color: #1f2937;
        }

        .dark .disadvantages-box h3 {
            color: #f9fafb;
        }

        .disadvantages-box p,
        .disadvantages-box li {
            color: #4b5563;
        }

        .dark .disadvantages-box p,
        .dark .disadvantages-box li {
            color: #e5e7eb;
        }

        .advantages-number,
        .disadvantages-number {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
            color: white;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }

        .advantages-number {
            background: #10b981;
        }

        .disadvantages-number {
            background: #ef4444;
        }

        .pros-cons-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }

        .pros-cons-list {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }

        .pros-cons-list li {
            padding: 0.25rem 0;
            font-size: 0.875rem;
            line-height: 1.25;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="mb-8" style="position: relative;">
            <div style="position: absolute; top: 0; right: 0; z-index: 10;">
                <button id="darkModeToggle" class="dark-toggle">
                    <svg class="hidden" id="sunIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
                        </path>
                    </svg>
                    <svg id="moonIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="text-center">
                <h1 class="text-4xl font-bold gradient-text mb-4">
                    Leaky Bucket Algorithm
                </h1>
                <p class="text-gray-600 dark:text-gray-00 text-lg max-w-2xl mx-auto">
                    Leaky Bucket algorithm smooths bursty traffic into a
                    steady stream
                </p>
            </div>
        </div>

        <div class="grid lg:grid-cols-2">
            <div>
                <div class="card">
                    <div class="flex flex-row" style="gap:4rem; align-items: flex-start;">
                        <div style="flex:2; min-width:260px;">
                            <div class="flex justify-between items-center mb-2">
                                <h2 class="text-xl font-semibold text-gray-800 dark:text-white">Bucket Visualization
                                </h2>
                                <span id="queueStatus" class="queue-status">0 / 10</span>
                            </div>
                            <div id="statusMessage" class="status-message status-info mb-2"
                                style="min-height: 60px; display: flex; align-items: center; justify-content: center; max-width: 300px; margin: 0 auto 1rem;">
                                Ready to accept API requests
                            </div>
                            <div class="bucket-container" style="margin-bottom:5;">
                                <div id="incoming-request-container" class="incoming-request-container"></div>
                                <div class="bucket-visual">
                                    <div id="bucket-water" class="bucket-water" style="height: 0%;"></div>
                                    <div id="bucket-queue" class="bucket-queue">
                                    </div>
                                </div>
                                <div id="leaking-request-container" class="leaking-request-container"></div>
                            </div>
                        </div>
                        <div style="flex:1; min-width:220px;">
                            <div class="card control-section" style="margin-bottom:0;">
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-300 mb-4">Configuration
                                </h3>
                                <div class="control-grid" style="grid-template-columns:1fr;">
                                    <div>
                                        <label for="leakRateSelector" class="control-label">Leak Rate</label>
                                        <select id="leakRateSelector" class="select">
                                            <option value="4000">Slow (1 per 4s)</option>
                                            <option value="2000" selected>Normal (1 per 2s)</option>
                                            <option value="500">Fast (1 per 0.5s)</option>
                                            <option value="9999999">Disabled</option>
                                        </select>
                                    </div>
                                    <button id="addRequestBtn" class="btn btn-primary" style="margin-top:1rem;">
                                        Make API Request
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="text-xl font-semibold mb-6 text-gray-800 dark:text-gray-300">How Leaky Bucket Works</h2>

                <div class="space-y-6">
                    <div class="step-card">
                        <div class="flex items-start">
                            <div class="step-number">1</div>
                            <div>
                                <h3 class="font-semibold mb-2">The Analogy</h3>
                                <p class="text-sm">Imagine a bucket with a small hole at the bottom. This bucket
                                    represents a queue that can hold incoming API requests. The bucket has a fixed
                                    capacity, just like the queue has a finite size.</p>
                            </div>
                        </div>
                    </div>

                    <div class="step-card">
                        <div class="flex items-start">
                            <div class="step-number">2</div>
                            <div>
                                <h3 class="font-semibold mb-2">Incoming Requests (Filling the Bucket)</h3>
                                <p class="text-sm">When a new request arrives, it's like a drop of water being added to
                                    the bucket. If there's space, the request is placed in the queue (the bucket). Click
                                    the 'Make API Request' button to see this happen.</p>
                            </div>
                        </div>
                    </div>

                    <div class="step-card">
                        <div class="flex items-start">
                            <div class="step-number">3</div>
                            <div>
                                <h3 class="font-semibold mb-2">The Queue (Water in the Bucket)</h3>
                                <p class="text-sm">The requests in the bucket form a First-In, First-Out (FIFO) queue.
                                    The first request that came in will be the first one to be processed, just as the
                                    water at the bottom of the bucket leaks out first.</p>
                            </div>
                        </div>
                    </div>

                    <div class="step-card">
                        <div class="flex items-start">
                            <div class="step-number">4</div>
                            <div>
                                <h3 class="font-semibold mb-2">The Leak (Processing Requests)</h3>
                                <p class="text-sm">The hole in the bucket allows requests to "leak" out at a constant,
                                    fixed rate. This represents processing the requests. Crucially, this leak rate is
                                    independent of how quickly requests arrive (the "burstiness" of the input).</p>
                            </div>
                        </div>
                    </div>

                    <div class="step-card">
                        <div class="flex items-start">
                            <div class="step-number">5</div>
                            <div>
                                <h3 class="font-semibold mb-2">Bucket Overflow (Handling Excess Load)</h3>
                                <p class="text-sm">If requests arrive faster than they can leak out, the bucket will
                                    fill up. If a new request arrives when the bucket is already at full capacity, it is
                                    rejected or "dropped". It cannot be added to the queue.</p>
                            </div>
                        </div>
                    </div>

                    <div class="step-card">
                        <div class="flex items-start">
                            <div class="step-number">6</div>
                            <div>
                                <h3 class="font-semibold mb-2">The Outcome (Smoothed Output)</h3>
                                <p class="text-sm">The key benefit of the Leaky Bucket algorithm is that it takes a
                                    potentially bursty, unpredictable stream of incoming requests and turns it into a
                                    smooth, constant, and predictable output stream of processed requests.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <div class="grid grid-cols-2 gap-6">
                        <div class="advantages-box">
                            <div class="flex items-start">
                                <div class="advantages-number">✓</div>
                                <div>
                                    <h3 class="pros-cons-title">Advantages</h3>
                                    <ul class="pros-cons-list">
                                        <li>Smooth, predictable output rate</li>
                                        <li>Handles traffic bursts gracefully</li>
                                        <li>Natural traffic shaping mechanism</li>
                                        <li>Simple to implement and understand</li>
                                        <li>Memory efficient with fixed queue</li>
                                        <li>Prevents downstream overload</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="disadvantages-box">
                            <div class="flex items-start">
                                <div class="disadvantages-number">!</div>
                                <div>
                                    <h3 class="pros-cons-title">Disadvantages</h3>
                                    <ul class="pros-cons-list">
                                        <li>May introduce processing delays</li>
                                        <li>Queue can become bottleneck</li>
                                        <li>Drops requests when bucket is full</li>
                                        <li>Fixed capacity limits scalability</li>
                                        <li>No priority handling for requests</li>
                                        <li>Potential for stale request processing</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const addRequestBtn = document.getElementById('addRequestBtn');
            const leakRateSelector = document.getElementById('leakRateSelector');
            const bucketQueueDiv = document.getElementById('bucket-queue');
            const bucketWaterDiv = document.getElementById('bucket-water');
            const queueStatusSpan = document.getElementById('queueStatus');
            const statusMessageDiv = document.getElementById('statusMessage');
            const incomingContainer = document.getElementById('incoming-request-container');
            const leakingContainer = document.getElementById('leaking-request-container');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const moonIcon = document.getElementById('moonIcon');
            const sunIcon = document.getElementById('sunIcon');

            // --- State Variables ---
            const BUCKET_CAPACITY = 10;
            let requestQueue = [];
            let leakRate = parseInt(leakRateSelector.value, 10);
            let leakIntervalId = null;
            let requestIdCounter = 0;
            let isProcessingRequest = false;
            let pendingRequests = [];

            // --- Core Functions ---

            /**
             * Creates a visual representation of a request.
             */
            function createRequestElement(id) {
                const requestEl = document.createElement('div');
                requestEl.id = `req-${id}`;
                requestEl.className = 'request-item';
                return requestEl;
            }

            /**
             * Updates all visual elements based on the current state.
             */
            function updateVisuals() {
                // Update queue count text
                queueStatusSpan.textContent = `${requestQueue.length} / ${BUCKET_CAPACITY}`;

                // Update water level
                const waterHeight = (requestQueue.length / BUCKET_CAPACITY) * 100;
                bucketWaterDiv.style.height = `${waterHeight}%`;

                // Fix: Always show exactly requestQueue.length dots, never more
                bucketQueueDiv.innerHTML = "";
                for (let i = 0; i < requestQueue.length; i++) {
                    const req = requestQueue[i];
                    const queuedRequestEl = createRequestElement(req.id);
                    bucketQueueDiv.appendChild(queuedRequestEl);
                }
            }

            /**
             * Displays a status message.
             */
            function showStatusMessage(text, type = 'info') {
                statusMessageDiv.textContent = text;
                // Use orange for 'Request Added to Queue', green for 'Request Processed'
                if (text.includes('Request Added to Queue')) {
                    statusMessageDiv.className = 'status-message status-success mb-4';
                } else if (text.includes('Request Processed')) {
                    statusMessageDiv.className = 'status-message status-processed mb-4';
                } else {
                    statusMessageDiv.className = `status-message status-${type} mb-4`;
                }
                statusMessageDiv.style.display = 'flex';
                statusMessageDiv.style.alignItems = 'center';
                statusMessageDiv.style.justifyContent = 'center';
                statusMessageDiv.style.minHeight = '60px';
                statusMessageDiv.style.maxWidth = '300px';
                statusMessageDiv.style.margin = '0 auto 1rem';

                // Auto-clear after 3 seconds if not a persistent message
                if (type !== 'info' || text !== 'Ready to accept requests') {
                    setTimeout(() => {
                        if (statusMessageDiv.textContent === text) {
                            showStatusMessage('Ready to accept requests', 'info');
                        }
                    }, 3000);
                }
            }

            /**
             * Processes the next pending request in the queue
             */
            function processNextPendingRequest() {
                if (pendingRequests.length > 0 && !isProcessingRequest) {
                    const nextRequest = pendingRequests.shift();
                    executeRequest(nextRequest);
                }
            }

            /**
             * Executes a single request with animation
             */
            function executeRequest(requestType) {
                if (isProcessingRequest) {
                    return;
                }

                isProcessingRequest = true;
                const incomingRequestEl = createRequestElement('incoming');
                incomingContainer.appendChild(incomingRequestEl);

                if (requestType === 'accept') {
                    incomingRequestEl.classList.add('animate-drop-in');
                    showStatusMessage('✅ Request Added to Queue', 'success');

                    incomingRequestEl.addEventListener('animationend', () => {
                        incomingContainer.innerHTML = '';
                        const newRequestId = ++requestIdCounter;
                        const newRequest = { id: newRequestId };
                        requestQueue.push(newRequest);

                        const queuedRequestEl = createRequestElement(newRequestId);
                        bucketQueueDiv.appendChild(queuedRequestEl);

                        updateVisuals();
                        isProcessingRequest = false;

                        // Process next request if any pending
                        setTimeout(processNextPendingRequest, 50);
                    }, { once: true });

                } else {
                    incomingRequestEl.classList.add('animate-drop-reject');
                    showStatusMessage('❌ Bucket Full - Request Dropped', 'error');

                    incomingRequestEl.addEventListener('animationend', () => {
                        incomingContainer.innerHTML = '';
                        isProcessingRequest = false;

                        // Process next request if any pending
                        setTimeout(processNextPendingRequest, 50);
                    }, { once: true });
                }
            }

            /**
             * Handles adding a new request to the bucket.
             */
            function addRequest() {
                // Only count actual requests in the queue for capacity check
                const requestType = requestQueue.length < BUCKET_CAPACITY ? 'accept' : 'reject';

                if (!isProcessingRequest) {
                    executeRequest(requestType);
                } else {
                    // Queue the request for later processing
                    pendingRequests.push(requestType);
                }
            }

            /**
             * Counts how many pending requests will be accepted
             */
            function countPendingAcceptRequests() {
                return pendingRequests.filter(req => req === 'accept').length;
            }

            /**
             * Processes one request from the queue (the "leak").
             */
            function processRequest() {
                if (requestQueue.length > 0) {
                    const processedRequest = requestQueue.shift(); // FIFO
                    const requestElToRemove = document.getElementById(`req-${processedRequest.id}`);

                    if (requestElToRemove) {
                        requestElToRemove.remove();
                    }

                    const leakingRequestEl = createRequestElement('leaking');
                    leakingContainer.appendChild(leakingRequestEl);
                    leakingRequestEl.classList.add('animate-leak-out');

                    showStatusMessage('🔄 API Request Processed', 'info');

                    leakingRequestEl.addEventListener('animationend', () => {
                        leakingContainer.innerHTML = ''; // Clean up
                    }, { once: true });

                    updateVisuals();
                }
            }

            /**
             * Starts the interval for processing requests.
             */
            function startLeaking() {
                if (leakIntervalId) {
                    clearInterval(leakIntervalId);
                }
                if (leakRate < 9999999) {
                    leakIntervalId = setInterval(processRequest, leakRate);
                }
            }

            // --- Dark Mode ---
            function setDarkMode(isDark) {
                if (isDark) {
                    document.documentElement.classList.add('dark');
                    moonIcon.classList.add('hidden');
                    sunIcon.classList.remove('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    moonIcon.classList.remove('hidden');
                    sunIcon.classList.add('hidden');
                }
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            }

            // --- Event Listeners ---
            addRequestBtn.addEventListener('click', addRequest);

            leakRateSelector.addEventListener('change', (e) => {
                leakRate = parseInt(e.target.value, 10);
                startLeaking();
                showStatusMessage(`⚙️ Leak rate updated`, 'info');
            });

            darkModeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.contains('dark');
                setDarkMode(!isDark);
            });

            // --- Initialization ---
            // Check system preference or saved theme
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const savedTheme = localStorage.getItem('theme');

            let isDark = false;
            if (savedTheme) {
                isDark = savedTheme === 'dark';
            } else {
                isDark = prefersDark;
            }

            setDarkMode(isDark);
            updateVisuals();
            startLeaking();
        });
    </script>
</body>

</html>